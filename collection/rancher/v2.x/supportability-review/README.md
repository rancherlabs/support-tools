Note: The files in this folder are mirrored from another location, do not edit directly.

# Rancher Supportability Review - Collection Tool
Ensure business continuity with ongoing reviews and advice. Get faster resolutions, prevent incidents, minimize drift whilst staying conformant with our validated configurations.

üìù Note: This script is intended to collect info from Rancher upstream cluster

‚ÑπÔ∏è Info: What's being collected?
[Jump to Data Collection Section](#data-collection-overview)

# ‚ùóBefore You Begin: Environment Assessment ‚ùó

## Network Environment Check
Please verify your environment type and requirements:

### ‚úÖ Internet-Connected Environment Requirements
- Access to Rancher URL
- Access to `https://raw.githubusercontent.com/` (for script download)
- Access to `ghcr.io/rancherlabs` (for container images)

> ‚ÑπÔ∏è **Info:** The collection tool can run on any machine that has access to the Rancher URL and container runtime e.g your laptop with docker installed

### üîí Airgapped Environment Requirements
You will need to mirror these container images to your private registry:
- Supportability Review Image: `rancher/supportability-review:latest`
- Sonobuoy Image: `rancher/mirrored-sonobuoy-sonobuoy:latest`

## Security Policy Check
If your clusters use any of these security tools, review the required configurations:

1. **Pod Security Admission/Policies**
   - Sonobuoy pods require privileged access
   - Collection pods need access to node information

2. **Network Policies**
   - Allow egress traffic for collection pods
   - Allow communication between Sonobuoy aggregator and collection pods

3. **Kyverno Policies**
   - Must exclude `sonobuoy` namespace from restrictive policies
   - Example configuration provided in Security Policies section

4. **Image Pull Policies**
   - Verify allowed registries in your security policies
   - Configure image pull secrets if required

[Security Policies in Detail](./security-policies.md) | Security configuration | Policy requirements and examples |

## Permission Requirements
1. **Rancher Access**
   - Bearer token must be generated by cluster owner (not member)
   - Token requires full access to target clusters
   - Token should not be scoped and have full access
   - [How to generate a token](https://ranchermanager.docs.rancher.com/reference-guides/user-settings/api-keys#docusaurus_skipToContent_fallback)


2. **Script Requirements**
   - Docker installed and running (or nerdctl/podman)
   - User must be root or in docker group

3. **Downstream Clusters must be Active**
   - Please ensure that your downstream clusters are listed as Active in Rancher
   - Any cluster in updating or not active will NOT be collected for review

4. **SELinux**
   - Please use `export ENABLE_PRIVILEGED="true"`, if SELinux is enabled.

# ‚úÖ Post Assesment - Installation Steps ‚úÖ

### 1. Environment Preparation


```shell
# Download script
wget https://raw.githubusercontent.com/rancherlabs/support-tools/master/collection/rancher/v2.x/supportability-review/collect.sh
chmod +x collect.sh
```

#### For Airgapped Environments
```shell
# Mirror required images
$ export PRIVATE_REGISTRY="registry.example.com:5000"
$ docker pull rancher/supportability-review:latest
$ docker pull rancher/mirrored-sonobuoy-sonobuoy:latest
$ docker pull rancher/security-scan:v0.6.1
$ docker tag rancher/supportability-review:latest $PRIVATE_REGISTRY/rancher/supportability-review:latest
$ docker tag rancher/mirrored-sonobuoy-sonobuoy:latest $PRIVATE_REGISTRY/rancher/mirrored-sonobuoy-sonobuoy:latest
$ docker tag rancher/security-scan:v0.6.1 $PRIVATE_REGISTRY/rancher/security-scan:v0.6.1
$ docker push $PRIVATE_REGISTRY/rancher/supportability-review:latest
$ docker push $PRIVATE_REGISTRY/rancher/mirrored-sonobuoy-sonobuoy:latest
$ docker push $PRIVATE_REGISTRY/rancher/security-scan:v0.6.1
```

### 2. Configuration Setup

```shell
# Required for all environments
export RANCHER_URL="https://rancher.example.com"
export RANCHER_TOKEN="token-a1b2c:hp7nxfs25w5g7rlc6gkasddhzpphfjbgmcqg6g2kpv52gxg7tl2fgpq2q"

# Optional: For nodes with custom taints
export SONOBUOY_TOLERATION_FILE="/path/to/tolerations.yaml"

# Optional: For cluster-info dump
export SR_COLLECT_CLUSTER_INFO_DUMP=1

# Optional: Proxy settings
export COLLECTOR_HTTP_PROXY="http://proxy.example.com:8080"
export COLLECTOR_HTTPS_PROXY="https://proxy.example.com:8080"
```

### 3. Run Collection

#### Standard Environment
```shell
./collect.sh
```

#### Airgapped Environment
```shell
./collect.sh \
  --private-registry=$PRIVATE_REGISTRY
```
#### Airgapped Environment with Image Pull Secret
```shell
./collect.sh \
  --private-registry=$PRIVATE_REGISTRY \
  --private-registry-secret-username=<user name> \
  --private-registry-secret-password=<password>
```

#### Sonobuoy Namespace
By default, `sonobuoy` runs in the `sonobuoy` namespace. You can change the namespace used by `sonobuoy` by using the `--sonobuoy-namespace` argument. Note that `sonobuoy` deletes the namespace it used on exit.

## Troubleshooting Common Issues

### 1. Permission Issues
```
Error: pods is forbidden: User cannot list resource "pods"
Solution: Ensure bearer token is generated by cluster owner, not member
```

### 2. Cluster Access Issues
```
Info: No of clusters detected: X (less than expected)
Solution: Check if bearer token has access to all intended clusters
```

### 3. Security Policy Blocks
For Kyverno, add this exclusion to your policies:
```yaml
exclude:
  any:
  - resources:
      namespaces:
      - sonobuoy
```
Please refer to the [Security Policies](./security-policies.md) document for more details 


### 4. Node Tolerations
If collection fails due to node taints, create a tolerations.yaml:
```yaml
tolerations:
- operator: Exists  # This will ignore all taints
```

## Support
If you encounter issues, please share:
1. The complete error output
2. Your environment type (airgapped/connected)
3. Any security policies in place
4. The generated support bundle with SUSE Rancher Support Team

## Additional Notes
- Collection bundles are saved as tar.gz in the script directory
- If there is an issue collecting via Rancher, use `KUBECONFIG` instead on every cluster individually:
  ```shell
  export KUBECONFIG="/path/to/kubeconfig.yaml"
  ./collect.sh --downstream
  ```
- When doing a collection on individual cluster via `KUBECONFIG`, you must specify the type using `--upstream` or `--downstream`
- When providing a collection via `KUBECONFIG` be sure to include the local RMS cluster.

### Data Collection Overview

#### Scope of Collection
The supportability review tool collects diagnostic information from:
- Rancher Management Server
- Downstream Kubernetes clusters
- Individual nodes within clusters

#### Collection Methods
- Cluster-wide information via Rancher API
- Node-level diagnostics through Sonobuoy plugins
- System configuration and health metrics

#### Security & Privacy
- No sensitive application data or secrets are collected
- Node collection focuses on system configuration and Kubernetes components
- All collected data is bundled and encrypted
- Ability to mask hostnames and IP addresses via obfuscation feature.
- - enabling obfuscation will result in some checks being skipped or alltogether broken. Enable using the command line flag --obfuscate=true.

#### Detailed Collection Information
- [Collection Details](./collection-details.md) - Comprehensive inventory of collected data
  - Complete list of collected components
  - Data handling and security measures
  - Privacy considerations
  - Excluded data types

#### Security Configuration
- [Security Policies](./security-policies.md) - Security policy configuration guide
  - Kyverno configuration examples
  - Pod Security Policy requirements
  - Network Policy requirements
  - Image pull requirements

#### Quick Links
| Document | Purpose | Key Information |
|----------|----------|----------------|
| [Collection Details](./collection-details.md) | Data collection scope | What is/isn't collected |
| [Security Policies](./security-policies.md) | Security configuration | Policy requirements and examples |
